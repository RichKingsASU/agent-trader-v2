# This CI pipeline enforces institutional safety guarantees.
steps:
  - name: 'gcr.io/cloud-builders/bash'
    id: 'PHASE 1: preflight'
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        echo "===== PHASE 1: preflight ====="
        echo "BUILD_ID=${BUILD_ID}"
        echo "PROJECT_ID=${PROJECT_ID}"
        echo "SHORT_SHA=${SHORT_SHA}"
        echo "COMMIT_SHA=${COMMIT_SHA}"
        echo "TAG=${_TAG}"

  - name: 'gcr.io/cloud-builders/bash'
    id: 'PHASE 2: safety guard'
    waitFor: ['PHASE 1: preflight']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        echo "===== PHASE 2: safety guard ====="

        echo "--- Checking for ':latest' image tags ---"
        mapfile -t YAML_FILES < <(find . -type f \( -name "*.yaml" -o -name "*.yml" \) ! -name "cloudbuild*")
        if [ "${#YAML_FILES[@]}" -gt 0 ] && grep -nE "image:.*:latest\b" "${YAML_FILES[@]}"; then
          echo "❌ FAILED: Use of ':latest' image tag is forbidden."
          exit 1
        else
          echo "✅ PASSED: No ':latest' image tags found."
        fi

        echo "--- Checking for 'AGENT_MODE=EXECUTE' ---"
        mapfile -t CODE_FILES < <(find . -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.py" -o -name "*.sh" -o -name "Dockerfile" -o -name "Dockerfile.*" \) ! -name "cloudbuild*")
        if [ "${#CODE_FILES[@]}" -gt 0 ] && grep -nE "AGENT_MODE[[:space:]]*[:=][[:space:]]*(['\"])?EXECUTE\1" "${CODE_FILES[@]}" | grep -v "ALLOWED_AGENT_MODES"; then
          echo "❌ FAILED: AGENT_MODE must not be set to EXECUTE in committed code."
          exit 1
        else
          echo "✅ PASSED: No instances of 'AGENT_MODE=EXECUTE' found."
        fi

        echo "--- Checking for scaled execution agents (replicas > 0) ---"
        mapfile -t EXEC_AGENT_MANIFESTS < <(grep -rl --include="*.yaml" --include="*.yml" "name: execution-agent" ./k8s 2>/dev/null || true)
        SCALED_EXECUTION_AGENT=0
        for MANIFEST in "${EXEC_AGENT_MANIFESTS[@]}"; do
          if grep -nE "replicas:[[:space:]]*[1-9]" "$MANIFEST"; then
            SCALED_EXECUTION_AGENT=1
          fi
        done

        if [ "$SCALED_EXECUTION_AGENT" -eq 1 ]; then
          echo "❌ FAILED: Execution agent replicas must be 0 in committed code."
          exit 1
        fi
        echo "✅ PASSED: No execution agents found with replicas > 0."

  - name: 'gcr.io/cloud-builders/bash'
    id: 'PHASE 4: docker build'
    waitFor: ['PHASE 2: safety guard']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        echo "===== PHASE 4: docker build ====="

  # Build and push marketdata-mcp-server
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build marketdata-mcp-server'
    waitFor: ['PHASE 4: docker build']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        IMAGE_TAG="${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/marketdata-mcp-server:${_TAG}"
        echo "docker build tag=${IMAGE_TAG}"
        docker build -t "${IMAGE_TAG}" -f backend/Dockerfile.marketdata-mcp-server .

  - name: 'gcr.io/cloud-builders/bash'
    id: 'PHASE 3: import smoke'
    waitFor: ['Build marketdata-mcp-server']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        echo "===== PHASE 3: import smoke ====="

  - name: 'gcr.io/cloud-builders/bash'
    id: 'Import gate marketdata-mcp-server'
    waitFor: ['PHASE 3: import smoke']
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        set -euo pipefail
        IMAGE_REF='${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/marketdata-mcp-server:${_TAG}'
        chmod +x ./scripts/ci_import_gate.sh
        ./scripts/ci_import_gate.sh "${IMAGE_REF}" backend.app

  # Build and push strategy-engine
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build strategy-engine'
    waitFor: ['Import gate marketdata-mcp-server']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        IMAGE_TAG="${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/strategy-engine:${_TAG}"
        echo "docker build tag=${IMAGE_TAG}"
        docker build -t "${IMAGE_TAG}" -f infra/Dockerfile.strategy_engine .

  - name: 'gcr.io/cloud-builders/bash'
    id: 'Import gate strategy-engine'
    waitFor: ['Build strategy-engine']
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        set -euo pipefail
        IMAGE_REF='${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/strategy-engine:${_TAG}'
        chmod +x ./scripts/ci_import_gate.sh
        ./scripts/ci_import_gate.sh "${IMAGE_REF}" backend.strategy_engine.service

  # Build and push strategy-runtime (used by gamma and whale strategies)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build strategy-runtime'
    waitFor: ['Import gate strategy-engine']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        IMAGE_TAG="${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/strategy-runtime:${_TAG}"
        echo "docker build tag=${IMAGE_TAG}"
        docker build -t "${IMAGE_TAG}" -f backend/strategy_service/Dockerfile .

  - name: 'gcr.io/cloud-builders/bash'
    id: 'Import gate strategy-runtime'
    waitFor: ['Build strategy-runtime']
    entrypoint: 'bash'
    args:
      - "-c"
      - |
        set -euo pipefail
        IMAGE_REF='${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/strategy-runtime:${_TAG}'
        sh ./scripts/ci_import_gate.sh "${IMAGE_REF}" backend.strategy_service.app

  - name: 'gcr.io/cloud-builders/bash'
    id: 'PHASE 5: docker push'
    waitFor: ['Import gate strategy-runtime']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        echo "===== PHASE 5: docker push ====="

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push marketdata-mcp-server'
    waitFor: ['PHASE 5: docker push']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        IMAGE_TAG="${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/marketdata-mcp-server:${_TAG}"
        docker push "${IMAGE_TAG}"

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push strategy-engine'
    waitFor: ['Push marketdata-mcp-server']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        IMAGE_TAG="${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/strategy-engine:${_TAG}"
        docker push "${IMAGE_TAG}"

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push strategy-runtime'
    waitFor: ['Push strategy-engine']
    entrypoint: 'bash'
    args:
      - -ceu
      - |
        set -euo pipefail
        IMAGE_TAG="${_REGION}-docker.pkg.dev/${_PROJECT}/${_REPO}/strategy-runtime:${_TAG}"
        docker push "${IMAGE_TAG}"

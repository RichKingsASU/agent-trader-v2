apiVersion: batch/v1
kind: CronJob
metadata:
  name: ops-heartbeat-writer
  namespace: trading-floor
  labels:
    app.kubernetes.io/name: ops-heartbeat-writer
    app.kubernetes.io/component: ops
    app.kubernetes.io/part-of: agenttrader-v2
spec:
  schedule: "* * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app.kubernetes.io/name: ops-heartbeat-writer
            app.kubernetes.io/component: ops
            app.kubernetes.io/part-of: agenttrader-v2
        spec:
          serviceAccountName: trading-floor-sa
          restartPolicy: OnFailure
          containers:
            - name: heartbeat
              # Pin kubectl image tag: ':latest' is forbidden by CI guardrails.
              image: bitnami/kubectl:1.29.0
              imagePullPolicy: IfNotPresent
              command: ["/bin/sh", "-lc"]
              args:
                - |
                  set -euo pipefail
                  ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
                  echo "HEARTBEAT_CRON: namespace=trading-floor name=ops-heartbeat-writer ts=${ts}"
                  kubectl -n trading-floor patch configmap agenttrader-heartbeat-ops-cron \
                    --type merge \
                    -p "{\"data\":{\"last_seen\":\"${ts}\"}}"
